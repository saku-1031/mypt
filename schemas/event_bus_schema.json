{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Voice MCP Hub Event Bus Schema",
  "description": "JSON Schema definitions for all event bus topics in the Voice MCP Hub system",
  "definitions": {
    "audio.in": {
      "type": "object",
      "description": "Audio input stream event",
      "required": ["session_id", "chunk", "timestamp"],
      "properties": {
        "session_id": {
          "type": "string",
          "description": "Unique session identifier",
          "format": "uuid"
        },
        "chunk": {
          "type": "string",
          "description": "Base64-encoded audio chunk",
          "contentEncoding": "base64"
        },
        "timestamp": {
          "type": "string",
          "description": "ISO 8601 timestamp of the audio chunk",
          "format": "date-time"
        },
        "sample_rate": {
          "type": "integer",
          "description": "Audio sample rate in Hz",
          "default": 16000
        },
        "channels": {
          "type": "integer",
          "description": "Number of audio channels",
          "default": 1
        }
      }
    },
    "stt.partial": {
      "type": "object",
      "description": "Partial ASR result event",
      "required": ["session_id", "text", "confidence"],
      "properties": {
        "session_id": {
          "type": "string",
          "description": "Unique session identifier",
          "format": "uuid"
        },
        "text": {
          "type": "string",
          "description": "Partial transcription text"
        },
        "confidence": {
          "type": "number",
          "description": "Confidence score (0.0-1.0)",
          "minimum": 0.0,
          "maximum": 1.0
        },
        "timestamp": {
          "type": "string",
          "description": "ISO 8601 timestamp",
          "format": "date-time"
        }
      }
    },
    "stt.final": {
      "type": "object",
      "description": "Final ASR result event",
      "required": ["session_id", "text", "confidence", "duration"],
      "properties": {
        "session_id": {
          "type": "string",
          "description": "Unique session identifier",
          "format": "uuid"
        },
        "text": {
          "type": "string",
          "description": "Final transcription text"
        },
        "confidence": {
          "type": "number",
          "description": "Confidence score (0.0-1.0)",
          "minimum": 0.0,
          "maximum": 1.0
        },
        "duration": {
          "type": "number",
          "description": "Duration of the utterance in seconds",
          "minimum": 0
        },
        "timestamp": {
          "type": "string",
          "description": "ISO 8601 timestamp",
          "format": "date-time"
        },
        "alternatives": {
          "type": "array",
          "description": "Alternative transcriptions",
          "items": {
            "type": "object",
            "properties": {
              "text": {
                "type": "string"
              },
              "confidence": {
                "type": "number",
                "minimum": 0.0,
                "maximum": 1.0
              }
            }
          }
        }
      }
    },
    "nlu.intent": {
      "type": "object",
      "description": "Extracted intent event",
      "required": ["session_id", "intent", "entities", "confidence"],
      "properties": {
        "session_id": {
          "type": "string",
          "description": "Unique session identifier",
          "format": "uuid"
        },
        "intent": {
          "type": "string",
          "description": "Detected intent name (e.g., 'calendar.add', 'memo.create')"
        },
        "entities": {
          "type": "object",
          "description": "Extracted entities (key-value pairs)",
          "additionalProperties": true
        },
        "confidence": {
          "type": "number",
          "description": "Confidence score (0.0-1.0)",
          "minimum": 0.0,
          "maximum": 1.0
        },
        "timestamp": {
          "type": "string",
          "description": "ISO 8601 timestamp",
          "format": "date-time"
        },
        "source_text": {
          "type": "string",
          "description": "Original text that was analyzed"
        }
      }
    },
    "mcp.call": {
      "type": "object",
      "description": "MCP capability call request event",
      "required": ["call_id", "capability", "args"],
      "properties": {
        "call_id": {
          "type": "string",
          "description": "Unique call identifier",
          "format": "uuid"
        },
        "session_id": {
          "type": "string",
          "description": "Associated session identifier",
          "format": "uuid"
        },
        "capability": {
          "type": "string",
          "description": "Capability name (e.g., 'calendar.add', 'memo.create')",
          "pattern": "^[a-z]+\\.[a-z]+$"
        },
        "args": {
          "type": "object",
          "description": "Capability-specific arguments",
          "additionalProperties": true
        },
        "timeout": {
          "type": "integer",
          "description": "Timeout in milliseconds",
          "default": 2000,
          "minimum": 100
        },
        "timestamp": {
          "type": "string",
          "description": "ISO 8601 timestamp",
          "format": "date-time"
        },
        "priority": {
          "type": "string",
          "description": "Call priority",
          "enum": ["low", "normal", "high"],
          "default": "normal"
        }
      }
    },
    "mcp.result": {
      "type": "object",
      "description": "MCP capability call result event",
      "required": ["call_id", "status"],
      "properties": {
        "call_id": {
          "type": "string",
          "description": "Unique call identifier matching the request",
          "format": "uuid"
        },
        "status": {
          "type": "string",
          "description": "Result status",
          "enum": ["success", "error", "timeout"]
        },
        "result": {
          "type": "object",
          "description": "Result data (present if status is 'success')",
          "additionalProperties": true
        },
        "error": {
          "type": "object",
          "description": "Error details (present if status is 'error')",
          "properties": {
            "code": {
              "type": "string",
              "description": "Error code"
            },
            "message": {
              "type": "string",
              "description": "Human-readable error message"
            },
            "details": {
              "type": "object",
              "description": "Additional error context",
              "additionalProperties": true
            }
          }
        },
        "timestamp": {
          "type": "string",
          "description": "ISO 8601 timestamp",
          "format": "date-time"
        },
        "duration": {
          "type": "number",
          "description": "Execution duration in milliseconds",
          "minimum": 0
        }
      }
    },
    "talk.say": {
      "type": "object",
      "description": "TTS playback instruction event",
      "required": ["session_id", "text"],
      "properties": {
        "session_id": {
          "type": "string",
          "description": "Unique session identifier",
          "format": "uuid"
        },
        "text": {
          "type": "string",
          "description": "Text to be synthesized and played"
        },
        "voice": {
          "type": "string",
          "description": "Voice identifier (e.g., 'ja-JP-Neural2-B')",
          "default": "ja-JP-Neural2-B"
        },
        "priority": {
          "type": "string",
          "description": "Playback priority",
          "enum": ["low", "normal", "high", "urgent"],
          "default": "normal"
        },
        "speaking_rate": {
          "type": "number",
          "description": "Speaking rate multiplier",
          "default": 1.0,
          "minimum": 0.5,
          "maximum": 2.0
        },
        "pitch": {
          "type": "number",
          "description": "Pitch adjustment in semitones",
          "default": 0.0,
          "minimum": -20.0,
          "maximum": 20.0
        },
        "timestamp": {
          "type": "string",
          "description": "ISO 8601 timestamp",
          "format": "date-time"
        },
        "interruptible": {
          "type": "boolean",
          "description": "Whether this utterance can be interrupted by barge-in",
          "default": true
        }
      }
    },
    "policy.confirm": {
      "type": "object",
      "description": "Confirmation dialog request event",
      "required": ["session_id", "action", "args"],
      "properties": {
        "session_id": {
          "type": "string",
          "description": "Unique session identifier",
          "format": "uuid"
        },
        "confirm_id": {
          "type": "string",
          "description": "Unique confirmation request identifier",
          "format": "uuid"
        },
        "action": {
          "type": "string",
          "description": "Action requiring confirmation (e.g., 'send_message', 'delete_event')"
        },
        "args": {
          "type": "object",
          "description": "Action arguments to be confirmed",
          "additionalProperties": true
        },
        "timeout": {
          "type": "integer",
          "description": "Confirmation timeout in seconds",
          "default": 10,
          "minimum": 5
        },
        "prompt": {
          "type": "string",
          "description": "Confirmation prompt text"
        },
        "timestamp": {
          "type": "string",
          "description": "ISO 8601 timestamp",
          "format": "date-time"
        }
      }
    },
    "policy.choice": {
      "type": "object",
      "description": "User choice result event",
      "required": ["session_id", "choice", "timestamp"],
      "properties": {
        "session_id": {
          "type": "string",
          "description": "Unique session identifier",
          "format": "uuid"
        },
        "confirm_id": {
          "type": "string",
          "description": "Confirmation request identifier",
          "format": "uuid"
        },
        "choice": {
          "type": "string",
          "description": "User's choice",
          "enum": ["confirm", "cancel", "timeout"]
        },
        "timestamp": {
          "type": "string",
          "description": "ISO 8601 timestamp",
          "format": "date-time"
        },
        "voice_input": {
          "type": "string",
          "description": "Original voice input (e.g., 'はい', 'キャンセル')"
        }
      }
    },
    "state.update": {
      "type": "object",
      "description": "Session state update event",
      "required": ["session_id", "state"],
      "properties": {
        "session_id": {
          "type": "string",
          "description": "Unique session identifier",
          "format": "uuid"
        },
        "state": {
          "type": "string",
          "description": "New session state",
          "enum": ["idle", "listening", "processing", "speaking", "confirming", "error", "closed"]
        },
        "context": {
          "type": "object",
          "description": "Session context data",
          "properties": {
            "turn_count": {
              "type": "integer",
              "description": "Number of turns in this session",
              "minimum": 0
            },
            "last_intent": {
              "type": "string",
              "description": "Last detected intent"
            },
            "references": {
              "type": "object",
              "description": "Context references (e.g., 'this', 'that')",
              "additionalProperties": true
            },
            "pending_actions": {
              "type": "array",
              "description": "Pending action identifiers",
              "items": {
                "type": "string"
              }
            }
          }
        },
        "timestamp": {
          "type": "string",
          "description": "ISO 8601 timestamp",
          "format": "date-time"
        },
        "metadata": {
          "type": "object",
          "description": "Additional metadata",
          "additionalProperties": true
        }
      }
    }
  }
}
